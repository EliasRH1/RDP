name: Ubuntu-Yaru-noVNC

on:
  workflow_dispatch:

jobs:
  ubuntu-gui:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Update system
        run: |
          sudo apt update

      - name: Install XFCE + Yaru theme
        run: |
          sudo apt install -y xfce4 xfce4-goodies \
            yaru-theme-gtk yaru-theme-icon yaru-theme-sound \
            tightvncserver novnc websockify dbus-x11

      - name: Create VNC password
        run: |
          mkdir -p ~/.vnc
          echo "ubuntu" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd

      - name: Configure VNC startup (XFCE)
        run: |
          cat <<EOF > ~/.vnc/xstartup
          #!/bin/sh
          unset SESSION_MANAGER
          unset DBUS_SESSION_BUS_ADDRESS
          exec startxfce4 &
          EOF
          chmod +x ~/.vnc/xstartup

      - name: Start VNC server
        run: |
          vncserver -kill :1 || true
          vncserver :1 -geometry 1280x720 -depth 24

      - name: Apply Ubuntu Yaru theme
        run: |
          xfconf-query -c xsettings -p /Net/ThemeName -s "Yaru"
          xfconf-query -c xsettings -p /Net/IconThemeName -s "Yaru"
          xfconf-query -c xsettings -p /Net/SoundThemeName -s "Yaru"

      - name: Start noVNC
        run: |
          websockify --web=/usr/share/novnc/ 6080 localhost:5901 &
          sleep 5

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Connect to Tailscale
        run: |
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-ubuntu-yaru

      - name: Show access info
        run: |
          IP=$(tailscale ip -4)
          echo ""
          echo "==============================="
          echo " UBUNTU LOOK READY"
          echo " URL: http://$IP:6080"
          echo " PASSWORD: ubuntu"
          echo " DESKTOP: XFCE + Yaru"
          echo "==============================="
          echo ""
          sleep 999999
