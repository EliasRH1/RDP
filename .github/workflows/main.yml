name: Linux-XRDP

on:
  workflow_dispatch:

jobs:
  linux-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Update system
        run: |
          sudo apt update

      - name: Install Desktop Environment (XFCE)
        run: |
          sudo apt install -y xfce4 xfce4-goodies xfconf dbus-x11

      - name: Install XRDP
        run: |
          sudo apt install -y xrdp
          sudo systemctl enable xrdp

      - name: Configure XRDP session correctly
        run: |
          # Set XFCE as default for all users
          echo "startxfce4" | sudo tee /etc/skel/.xsession
          
          # Clean broken env vars and force XFCE
          sudo sed -i '1i unset DBUS_SESSION_BUS_ADDRESS\nunset XDG_RUNTIME_DIR' /etc/xrdp/startwm.sh
          sudo sed -i 's/^exec.*/exec startxfce4 \&/' /etc/xrdp/startwm.sh
          
          sudo systemctl restart xrdp

      - name: Create RDP user
        run: |
          sudo useradd -m rdp
          echo "rdp:rdp12345" | sudo chpasswd
          sudo usermod -aG sudo rdp
          
          # Ensure session file exists for user
          sudo cp /etc/skel/.xsession /home/rdp/.xsession
          sudo chown rdp:rdp /home/rdp/.xsession

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Connect to Tailscale
        run: |
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-linux-xrdp

      - name: Show RDP access info
        run: |
          IP=$(tailscale ip -4)
          echo ""
          echo "==============================="
          echo " XRDP ACCESS READY"
          echo " IP: $IP"
          echo " PORT: 3389"
          echo " USER: rdp"
          echo " PASS: rdp12345"
          echo " SESSION: Xorg"
          echo "==============================="
          echo ""
          sleep 999999
