name: RDP + Sunshine (User Password OK)

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-2019
    timeout-minutes: 3600

    steps:
    # ===============================
    # 1. CONFIGURAR RDP
    # ===============================
    - name: Configure RDP
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
          -Name "fDenyTSConnections" -Value 0 -Force

        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
          -Name "UserAuthentication" -Value 0 -Force

        netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389

        Restart-Service TermService -Force

    # ===============================
    # 2. CREAR USUARIO RDP (TU CÓDIGO)
    # ===============================
    - name: Create RDP User with Secure Password
      run: |
        Add-Type -AssemblyName System.Security

        $charSet = @{
            Upper   = [char[]](65..90)      # A-Z
            Lower   = [char[]](97..122)     # a-z
            Number  = [char[]](48..57)      # 0-9
            Special = ([char[]](33..47) + [char[]](58..64) +
                       [char[]](91..96) + [char[]](123..126)) # Special characters
        }

        $rawPassword = @()
        $rawPassword += $charSet.Upper   | Get-Random -Count 4
        $rawPassword += $charSet.Lower   | Get-Random -Count 4
        $rawPassword += $charSet.Number  | Get-Random -Count 4
        $rawPassword += $charSet.Special | Get-Random -Count 4

        $password = -join ($rawPassword | Sort-Object { Get-Random })
        $securePass = ConvertTo-SecureString $password -AsPlainText -Force

        New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires
        Add-LocalGroupMember -Group "Administrators" -Member "RDP"
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP"

        echo "RDP_USER=RDP" >> $env:GITHUB_ENV
        echo "RDP_PASS=$password" >> $env:GITHUB_ENV

        if (-not (Get-LocalUser -Name "RDP")) {
            Write-Error "User creation failed"
            exit 1
        }

    # ===============================
    # 3. INSTALAR TAILSCALE
    # ===============================
    - name: Install Tailscale
      run: |
        Invoke-WebRequest https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi `
          -OutFile $env:TEMP\tailscale.msi

        Start-Process msiexec.exe -ArgumentList "/i `"$env:TEMP\tailscale.msi`" /quiet /norestart" -Wait

    # ===============================
    # 4. CONECTAR TAILSCALE
    # ===============================
    - name: Start Tailscale
      run: |
        & "C:\Program Files\Tailscale\tailscale.exe" up `
          --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} `
          --hostname=gh-runner-${{ github.run_id }}

        $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
        echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV

    # ===============================
    # 5. INSTALAR SUNSHINE
    # ===============================
    - name: Install Sunshine
      run: |
        Invoke-WebRequest `
          https://github.com/LizardByte/Sunshine/releases/download/v0.23.1/sunshine-windows-installer.exe `
          -OutFile $env:TEMP\sunshine.exe

        Start-Process $env:TEMP\sunshine.exe -ArgumentList "/S" -Wait

    # ===============================
    # 6. ABRIR PUERTOS SUNSHINE
    # ===============================
    - name: Open Sunshine Ports
      run: |
        netsh advfirewall firewall add rule name="Sunshine TCP" dir=in action=allow protocol=TCP localport=47984-47990
        netsh advfirewall firewall add rule name="Sunshine UDP" dir=in action=allow protocol=UDP localport=47998-48010

    # ===============================
    # 7. INICIAR SUNSHINE AUTOMÁTICAMENTE
    # ===============================
    - name: Start Sunshine
      run: |
        Start-Process "C:\Program Files\Sunshine\sunshine.exe"
        Start-Sleep 5
        Get-Process sunshine

    # ===============================
    # 8. INFO FINAL Y MANTENER VIVO
    # ===============================
    - name: Connection Info
      run: |
        Write-Host ""
        Write-Host "=============================="
        Write-Host " SUNSHINE LISTO"
        Write-Host "=============================="
        Write-Host "IP Tailscale : $env:TAILSCALE_IP"
        Write-Host ""
        Write-Host "RDP:"
        Write-Host "Usuario : $env:RDP_USER"
        Write-Host "Password: $env:RDP_PASS"
        Write-Host "=============================="

        while ($true) {
          Start-Sleep 300
        }
